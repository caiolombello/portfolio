<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Content Manager</title>
    <link href="config.yml" type="text/yaml" rel="cms-config-url">
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
  </head>
  <body>
    <script>
      // Debug logs
      console.log('Loading CMS...');
      
      // Ensure all required dependencies are loaded
      function initCMS() {
        if (!window.yaml) {
          console.error('YAML parser not loaded');
          document.body.innerHTML = '<div style="padding: 20px;">Error: YAML parser failed to load. Please check your internet connection and try again.</div>';
          return;
        }

        if (!window.CMS) {
          console.error('Decap CMS not loaded');
          document.body.innerHTML = '<div style="padding: 20px;">Error: Decap CMS failed to load. Please check your internet connection and try again.</div>';
          return;
        }

        // Manual initialization
        window.CMS_MANUAL_INIT = true;

        // Load and parse config
        fetch('/admin/config.yml')
          .then(response => {
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.text();
          })
          .then(config => {
            try {
              console.log('Config loaded successfully');
              const parsedConfig = window.yaml.parse(config);
              window.CMS.init({
                config: {
                  load_config_file: false,
                  ...parsedConfig
                }
              });
              console.log('CMS initialized successfully');
            } catch (parseError) {
              console.error('Failed to parse config:', parseError);
              document.body.innerHTML = `<div style="padding: 20px;">Error parsing CMS configuration. Please check that your config.yml is valid YAML.</div>`;
            }
          })
          .catch(error => {
            console.error('Failed to load config:', error);
            document.body.innerHTML = `<div style="padding: 20px;">Error loading CMS configuration: ${error.message}</div>`;
          });
      }

      // Initialize when the page is fully loaded
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initCMS);
      } else {
        initCMS();
      }
    </script>
  </body>
</html>
